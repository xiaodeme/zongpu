# 手机访问问题排查指南

## 问题现象
手机可以访问前端页面（3000端口），但在发送消息时出现错误：
```
抱歉，处理请求时发生错误：无法连接到后端服务器 (http://localhost:9621)
```

但手机可以直接访问后端健康检查接口：`http://192.168.3.18:9621/health` （正常返回）

## 问题分析

### 已确认的情况
1. ✅ 后端运行正常：监听在 `0.0.0.0:9621`，可以接受外部连接
2. ✅ 网络连通性正常：手机可以访问 `http://192.168.3.18:9621/health`
3. ✅ 前端已配置为监听所有接口：`host: '0.0.0.0'`，手机可以访问前端页面

### 可能的原因
错误信息显示后端URL为 `http://localhost:9621`，说明代码检测到的 `window.location.hostname` 可能是 `localhost`，而不是IP地址。

**可能的原因：**
1. 浏览器缓存了旧的JavaScript代码
2. 代码没有重新编译/重新加载
3. 浏览器特殊行为导致hostname显示为localhost

## 解决方案

### 步骤1：清理浏览器缓存
**在手机浏览器中：**
1. 完全关闭浏览器应用
2. 重新打开浏览器
3. 访问 `http://192.168.3.18:3000`
4. 如果浏览器支持，请清除该网站的缓存和Cookie

### 步骤2：检查控制台日志
**在手机上打开浏览器开发者工具**（如果可能），或者使用远程调试：
1. 打开页面后，查看控制台输出的启动信息：
   ```
   === 应用启动调试信息 ===
   当前访问地址信息: {
     hostname: "192.168.3.18",  // 应该是IP地址，而不是localhost
     protocol: "http:",
     port: "3000",
     href: "http://192.168.3.18:3000",
     origin: "http://192.168.3.18:3000"
   }
   ```

2. 发送消息时，查看控制台输出：
   ```
   [getDynamicBackendUrl] 运行时页面信息: {
     hostname: "192.168.3.18",  // 应该是IP地址
     protocol: "http:",
     ...
   }
   发送流式查询请求: {
     url: "http://192.168.3.18:9621/query/stream",  // 应该是IP地址
     ...
   }
   ```

### 步骤3：验证代码更新
确保前端开发服务器已经重新编译：
1. 检查开发服务器是否有新的编译输出
2. 如果使用 `npm run dev`，确保看到文件变化
3. 尝试强制刷新：在浏览器中按 `Ctrl+Shift+R` (Windows) 或 `Cmd+Shift+R` (Mac)

### 步骤4：使用硬刷新
如果使用手机浏览器：
- **Chrome**: 长按刷新按钮，选择"硬性重新加载"
- **Safari**: 关闭标签页，重新打开
- **其他浏览器**: 尝试清除网站数据

### 步骤5：验证访问方式
**重要：确保手机通过IP地址访问，而不是localhost**
- ✅ 正确：`http://192.168.3.18:3000`
- ❌ 错误：`http://localhost:3000` （手机无法解析localhost）

## 代码修改说明

### 主要修改
1. **动态获取后端URL**：代码现在在每次请求时动态获取 `window.location.hostname`，而不是使用构建时的值
2. **详细的调试信息**：添加了全面的控制台日志，帮助排查问题
3. **增强的错误处理**：提供更友好的错误提示

### 关键代码位置
- `client/src/api/lightrag.ts`: `getDynamicBackendUrl()` 函数
- `client/src/main.tsx`: 启动时的调试信息
- `client/src/lib/constants.ts`: 后端URL的初始值（仅用于初始化）

## 预期行为

### 正确的情况
当手机通过 `http://192.168.3.18:3000` 访问时：
1. 控制台应该显示 `hostname: "192.168.3.18"`
2. API请求应该发送到 `http://192.168.3.18:9621`
3. 消息发送应该正常工作

### 如果仍然显示localhost
如果控制台仍然显示 `hostname: "localhost"`，可能是：
1. 浏览器缓存问题（需要完全清理）
2. 代码没有更新（需要重新启动开发服务器）
3. 浏览器特殊行为（尝试使用其他浏览器）

## 备用方案

如果动态检测仍然有问题，可以手动设置环境变量：

1. 创建 `.env` 文件（在 `client` 目录下）：
   ```
   VITE_BACKEND_URL=http://192.168.3.18:9621
   ```

2. 重启开发服务器：
   ```bash
   cd client
   npm run dev
   ```

3. 注意：这种方式会将后端URL硬编码为特定IP，如果需要切换网络环境，需要修改环境变量

## 联系支持

如果问题仍然存在，请提供：
1. 手机浏览器控制台的完整日志
2. 手机访问的完整URL（截图或文字）
3. 后端服务器的IP地址
4. 前端开发服务器的输出日志

